<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>source Sdiff src/hotspot/share/gc/shenandoah </title>
</head><body id="SUNWwebrev">
<center><a href='../../../../../src/hotspot/share/gc/shared/jvmFlagConstraintsGC.hpp.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../index.html' target='_top'>index</a> <a href='../../../../../src/hotspot/share/gc/shenandoah/shenandoahHeap.hpp.sdiff.html' target='_top'>next &gt</a></center>
<h2>src/hotspot/share/gc/shenandoah/shenandoahHeap.cpp</h2>
<a class="print" href="javascript:print()">Print this page</a>
<pre>rev <a href="https://bugs.openjdk.java.net/browse/JDK-60221">60221</a> : imported patch big.patch</pre>

<table><tr valign="top">
<td><pre>

</pre><hr></hr><pre>
  55 #include "gc/shenandoah/shenandoahOopClosures.inline.hpp"
  56 #include "gc/shenandoah/shenandoahPacer.inline.hpp"
  57 #include "gc/shenandoah/shenandoahPadding.hpp"
  58 #include "gc/shenandoah/shenandoahParallelCleaning.inline.hpp"
  59 #include "gc/shenandoah/shenandoahRootProcessor.inline.hpp"
  60 #include "gc/shenandoah/shenandoahStringDedup.hpp"
  61 #include "gc/shenandoah/shenandoahTaskqueue.hpp"
  62 #include "gc/shenandoah/shenandoahUtils.hpp"
  63 #include "gc/shenandoah/shenandoahVerifier.hpp"
  64 #include "gc/shenandoah/shenandoahCodeRoots.hpp"
  65 #include "gc/shenandoah/shenandoahVMOperations.hpp"
  66 #include "gc/shenandoah/shenandoahWorkGroup.hpp"
  67 #include "gc/shenandoah/shenandoahWorkerPolicy.hpp"
  68 #include "gc/shenandoah/mode/shenandoahIUMode.hpp"
  69 #include "gc/shenandoah/mode/shenandoahPassiveMode.hpp"
  70 #include "gc/shenandoah/mode/shenandoahSATBMode.hpp"
  71 #if INCLUDE_JFR
  72 #include "gc/shenandoah/shenandoahJfrSupport.hpp"
  73 #endif
  74 
<span class="changed">  75 #include "memory/metaspace.hpp"</span>


  76 #include "oops/compressedOops.inline.hpp"
  77 #include "runtime/atomic.hpp"
  78 #include "runtime/globals.hpp"
  79 #include "runtime/interfaceSupport.inline.hpp"
  80 #include "runtime/orderAccess.hpp"
  81 #include "runtime/safepointMechanism.hpp"
  82 #include "runtime/vmThread.hpp"
  83 #include "services/mallocTracker.hpp"
  84 #include "utilities/powerOfTwo.hpp"
  85 
  86 #ifdef ASSERT
  87 template &lt;class T&gt;
  88 void ShenandoahAssertToSpaceClosure::do_oop_work(T* p) {
  89   T o = RawAccess&lt;&gt;::oop_load(p);
  90   if (! CompressedOops::is_null(o)) {
  91     oop obj = CompressedOops::decode_not_null(o);
  92     shenandoah_assert_not_forwarded(p, obj);
  93   }
  94 }
  95 

</pre><hr></hr><pre>
2246   {
2247     ShenandoahGCPhase phase(full_gc ?
2248                             ShenandoahPhaseTimings::full_gc_purge_class_unload :
2249                             ShenandoahPhaseTimings::purge_class_unload);
2250     bool purged_class = SystemDictionary::do_unloading(gc_timer());
2251 
2252     ShenandoahIsAliveSelector is_alive;
2253     uint num_workers = _workers-&gt;active_workers();
2254     ShenandoahClassUnloadingTask unlink_task(is_alive.is_alive_closure(), num_workers, purged_class);
2255     _workers-&gt;run_task(&amp;unlink_task);
2256   }
2257 
2258   {
2259     ShenandoahGCPhase phase(full_gc ?
2260                             ShenandoahPhaseTimings::full_gc_purge_cldg :
2261                             ShenandoahPhaseTimings::purge_cldg);
2262     ClassLoaderDataGraph::purge();
2263   }
2264   // Resize and verify metaspace
2265   MetaspaceGC::compute_new_size();
<span class="removed">2266   MetaspaceUtils::verify_metrics();</span>
2267 }
2268 
2269 // Weak roots are either pre-evacuated (final mark) or updated (final updaterefs),
2270 // so they should not have forwarded oops.
2271 // However, we do need to "null" dead oops in the roots, if can not be done
2272 // in concurrent cycles.
2273 void ShenandoahHeap::stw_process_weak_roots(bool full_gc) {
2274   ShenandoahGCPhase root_phase(full_gc ?
2275                                ShenandoahPhaseTimings::full_gc_purge :
2276                                ShenandoahPhaseTimings::purge);
2277   uint num_workers = _workers-&gt;active_workers();
2278   ShenandoahPhaseTimings::Phase timing_phase = full_gc ?
2279                                                ShenandoahPhaseTimings::full_gc_purge_weak_par :
2280                                                ShenandoahPhaseTimings::purge_weak_par;
2281   ShenandoahGCPhase phase(timing_phase);
2282   ShenandoahGCWorkerPhase worker_phase(timing_phase);
2283 
2284   // Cleanup weak roots
2285   if (has_forwarded_objects()) {
2286     ShenandoahForwardedIsAliveClosure is_alive;

</pre><hr></hr>
</pre></td><td><pre>

</pre><hr></hr><pre>
  55 #include "gc/shenandoah/shenandoahOopClosures.inline.hpp"
  56 #include "gc/shenandoah/shenandoahPacer.inline.hpp"
  57 #include "gc/shenandoah/shenandoahPadding.hpp"
  58 #include "gc/shenandoah/shenandoahParallelCleaning.inline.hpp"
  59 #include "gc/shenandoah/shenandoahRootProcessor.inline.hpp"
  60 #include "gc/shenandoah/shenandoahStringDedup.hpp"
  61 #include "gc/shenandoah/shenandoahTaskqueue.hpp"
  62 #include "gc/shenandoah/shenandoahUtils.hpp"
  63 #include "gc/shenandoah/shenandoahVerifier.hpp"
  64 #include "gc/shenandoah/shenandoahCodeRoots.hpp"
  65 #include "gc/shenandoah/shenandoahVMOperations.hpp"
  66 #include "gc/shenandoah/shenandoahWorkGroup.hpp"
  67 #include "gc/shenandoah/shenandoahWorkerPolicy.hpp"
  68 #include "gc/shenandoah/mode/shenandoahIUMode.hpp"
  69 #include "gc/shenandoah/mode/shenandoahPassiveMode.hpp"
  70 #include "gc/shenandoah/mode/shenandoahSATBMode.hpp"
  71 #if INCLUDE_JFR
  72 #include "gc/shenandoah/shenandoahJfrSupport.hpp"
  73 #endif
  74 
<span class="changed">  75 </span>
<span class="changed">  76 #include "memory/metaspace/classLoaderMetaspace.hpp"</span>
<span class="changed">  77 #include "memory/metaspace/metaspaceEnums.hpp"</span>
  78 #include "oops/compressedOops.inline.hpp"
  79 #include "runtime/atomic.hpp"
  80 #include "runtime/globals.hpp"
  81 #include "runtime/interfaceSupport.inline.hpp"
  82 #include "runtime/orderAccess.hpp"
  83 #include "runtime/safepointMechanism.hpp"
  84 #include "runtime/vmThread.hpp"
  85 #include "services/mallocTracker.hpp"
  86 #include "utilities/powerOfTwo.hpp"
  87 
  88 #ifdef ASSERT
  89 template &lt;class T&gt;
  90 void ShenandoahAssertToSpaceClosure::do_oop_work(T* p) {
  91   T o = RawAccess&lt;&gt;::oop_load(p);
  92   if (! CompressedOops::is_null(o)) {
  93     oop obj = CompressedOops::decode_not_null(o);
  94     shenandoah_assert_not_forwarded(p, obj);
  95   }
  96 }
  97 

</pre><hr></hr><pre>
2248   {
2249     ShenandoahGCPhase phase(full_gc ?
2250                             ShenandoahPhaseTimings::full_gc_purge_class_unload :
2251                             ShenandoahPhaseTimings::purge_class_unload);
2252     bool purged_class = SystemDictionary::do_unloading(gc_timer());
2253 
2254     ShenandoahIsAliveSelector is_alive;
2255     uint num_workers = _workers-&gt;active_workers();
2256     ShenandoahClassUnloadingTask unlink_task(is_alive.is_alive_closure(), num_workers, purged_class);
2257     _workers-&gt;run_task(&amp;unlink_task);
2258   }
2259 
2260   {
2261     ShenandoahGCPhase phase(full_gc ?
2262                             ShenandoahPhaseTimings::full_gc_purge_cldg :
2263                             ShenandoahPhaseTimings::purge_cldg);
2264     ClassLoaderDataGraph::purge();
2265   }
2266   // Resize and verify metaspace
2267   MetaspaceGC::compute_new_size();

2268 }
2269 
2270 // Weak roots are either pre-evacuated (final mark) or updated (final updaterefs),
2271 // so they should not have forwarded oops.
2272 // However, we do need to "null" dead oops in the roots, if can not be done
2273 // in concurrent cycles.
2274 void ShenandoahHeap::stw_process_weak_roots(bool full_gc) {
2275   ShenandoahGCPhase root_phase(full_gc ?
2276                                ShenandoahPhaseTimings::full_gc_purge :
2277                                ShenandoahPhaseTimings::purge);
2278   uint num_workers = _workers-&gt;active_workers();
2279   ShenandoahPhaseTimings::Phase timing_phase = full_gc ?
2280                                                ShenandoahPhaseTimings::full_gc_purge_weak_par :
2281                                                ShenandoahPhaseTimings::purge_weak_par;
2282   ShenandoahGCPhase phase(timing_phase);
2283   ShenandoahGCWorkerPhase worker_phase(timing_phase);
2284 
2285   // Cleanup weak roots
2286   if (has_forwarded_objects()) {
2287     ShenandoahForwardedIsAliveClosure is_alive;

</pre><hr></hr>
</pre></td>
</tr></table>
<center><a href='../../../../../src/hotspot/share/gc/shared/jvmFlagConstraintsGC.hpp.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../index.html' target='_top'>index</a> <a href='../../../../../src/hotspot/share/gc/shenandoah/shenandoahHeap.hpp.sdiff.html' target='_top'>next &gt</a></center>
</body></html>
