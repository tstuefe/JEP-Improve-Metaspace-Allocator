<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>source Udiff src/hotspot/share/memory/metaspace/metaspaceStatistics.hpp</title>

<style type="text/css" media="screen">
span.new {
    color: blue;
    font-weight: normal;
}
</style>

</head>
<body id="SUNWwebrev">
<center><a href='../../../../../src/hotspot/share/memory/metaspace/metaspaceStatistics.cpp.udiff.html' target='_top'>&lt prev</a> <a href='../../../../../index.html' target='_top'>index</a> <a href='../../../../../src/hotspot/share/memory/metaspace/virtualSpaceList.cpp.udiff.html' target='_top'>next &gt</a></center>
<h2>src/hotspot/share/memory/metaspace/metaspaceStatistics.hpp</h2>
        <a class="print" href="javascript:print()">Print this page</a>
<pre>rev <a href="https://bugs.openjdk.java.net/browse/JDK-60538">60538</a> : imported patch jep387-core.patch</pre>
        <pre>
</pre><hr /><pre>
<span class="newmarker">@@ -1,8 +1,8 @@</span>
 /*
<span class="removed">- * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.</span>
<span class="removed">- * Copyright (c) 2018 SAP SE. All rights reserved.</span>
<span class="new">+ * Copyright (c) 2018, 2020, Oracle and/or its affiliates. All rights reserved.</span>
<span class="new">+ * Copyright (c) 2018, 2020 SAP SE. All rights reserved.</span>
  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  *
  * This code is free software; you can redistribute it and/or modify it
  * under the terms of the GNU General Public License version 2 only, as
  * published by the Free Software Foundation.
</pre><hr /><pre>
<span class="newmarker">@@ -24,164 +24,143 @@</span>
  */
 
 #ifndef SHARE_MEMORY_METASPACE_METASPACESTATISTICS_HPP
 #define SHARE_MEMORY_METASPACE_METASPACESTATISTICS_HPP
 
<span class="removed">-#include "utilities/globalDefinitions.hpp"</span>
 #include "memory/metaspace.hpp" // for MetadataType enum
<span class="removed">-#include "memory/metaspace/metachunk.hpp" // for ChunkIndex enum</span>
<span class="new">+#include "memory/metaspace/chunkLevel.hpp"</span>
<span class="new">+#include "utilities/globalDefinitions.hpp"</span>
 
 class outputStream;
 
 namespace metaspace {
 
<span class="removed">-// Contains statistics for a number of free chunks.</span>
<span class="removed">-class FreeChunksStatistics {</span>
<span class="removed">-  uintx _num;         // Number of chunks</span>
<span class="removed">-  size_t _cap;        // Total capacity, in words</span>
<span class="removed">-</span>
<span class="removed">-public:</span>
<span class="removed">-  FreeChunksStatistics();</span>
<span class="new">+// Contains a number of data output structures:</span>
<span class="new">+//</span>
<span class="new">+// - cm_stats_t</span>
<span class="new">+// - clms_stats_t -&gt; arena_stats_t -&gt; in_use_chunk_stats_t</span>
<span class="new">+//</span>
<span class="new">+// used for the various XXXX::add_to_statistic() methods in MetaspaceArena, ClassLoaderMetaspace</span>
<span class="new">+//  and ChunkManager, respectively.</span>
 
<span class="removed">-  void reset();</span>
<span class="new">+struct cm_stats_t {</span>
 
<span class="removed">-  uintx num() const { return _num; }</span>
<span class="removed">-  size_t cap() const { return _cap; }</span>
<span class="removed">-</span>
<span class="removed">-  void add(uintx n, size_t s);</span>
<span class="removed">-  void add(const FreeChunksStatistics&amp; other);</span>
<span class="removed">-  void print_on(outputStream* st, size_t scale) const;</span>
<span class="new">+  // How many chunks per level are checked in.</span>
<span class="new">+  int num_chunks[chunklevel::NUM_CHUNK_LEVELS];</span>
 
<span class="removed">-}; // end: FreeChunksStatistics</span>
<span class="new">+  // Size, in words, of the sum of all committed areas in this chunk manager, per level.</span>
<span class="new">+  size_t committed_word_size[chunklevel::NUM_CHUNK_LEVELS];</span>
 
<span class="new">+  cm_stats_t() : num_chunks(), committed_word_size() {}</span>
 
<span class="removed">-// Contains statistics for a ChunkManager.</span>
<span class="removed">-class ChunkManagerStatistics {</span>
<span class="new">+  void add(const cm_stats_t&amp; other);</span>
 
<span class="removed">-  FreeChunksStatistics _chunk_stats[NumberOfInUseLists];</span>
<span class="new">+  // Returns total word size of all chunks in this manager.</span>
<span class="new">+  size_t total_word_size() const;</span>
 
<span class="removed">-public:</span>
<span class="removed">-</span>
<span class="removed">-  // Free chunk statistics, by chunk index.</span>
<span class="removed">-  const FreeChunksStatistics&amp; chunk_stats(ChunkIndex index) const   { return _chunk_stats[index]; }</span>
<span class="removed">-  FreeChunksStatistics&amp; chunk_stats(ChunkIndex index)               { return _chunk_stats[index]; }</span>
<span class="removed">-</span>
<span class="removed">-  void reset();</span>
<span class="removed">-  size_t total_capacity() const;</span>
<span class="new">+  // Returns total committed word size of all chunks in this manager.</span>
<span class="new">+  size_t total_committed_word_size() const;</span>
 
   void print_on(outputStream* st, size_t scale) const;
 
<span class="removed">-}; // ChunkManagerStatistics</span>
<span class="new">+  DEBUG_ONLY(void verify() const;)</span>
 
<span class="removed">-// Contains statistics for a number of chunks in use.</span>
<span class="removed">-// Each chunk has a used and free portion; however, there are current chunks (serving</span>
<span class="removed">-// potential future metaspace allocations) and non-current chunks. Unused portion of the</span>
<span class="removed">-// former is counted as free, unused portion of the latter counts as waste.</span>
<span class="removed">-class UsedChunksStatistics {</span>
<span class="removed">-  uintx _num;     // Number of chunks</span>
<span class="removed">-  size_t _cap;    // Total capacity in words.</span>
<span class="removed">-  size_t _used;   // Total used area, in words</span>
<span class="removed">-  size_t _free;   // Total free area (unused portions of current chunks), in words</span>
<span class="removed">-  size_t _waste;  // Total waste area (unused portions of non-current chunks), in words</span>
<span class="removed">-  size_t _overhead; // Total sum of chunk overheads, in words.</span>
<span class="new">+};</span>
 
<span class="removed">-public:</span>
<span class="new">+// Contains statistics for one or multiple chunks in use.</span>
<span class="new">+struct in_use_chunk_stats_t {</span>
 
<span class="removed">-  UsedChunksStatistics();</span>
<span class="new">+  // Number of chunks</span>
<span class="new">+  int num;</span>
 
<span class="removed">-  void reset();</span>
<span class="new">+  // Note:</span>
<span class="new">+  // capacity = committed + uncommitted</span>
<span class="new">+  //            committed = used + free + waste</span>
 
<span class="removed">-  uintx num() const { return _num; }</span>
<span class="new">+  // Capacity (total sum of all chunk sizes) in words.</span>
<span class="new">+  // May contain committed and uncommitted space.</span>
<span class="new">+  size_t word_size;</span>
 
<span class="removed">-  // Total capacity, in words</span>
<span class="removed">-  size_t cap() const { return _cap; }</span>
<span class="new">+  // Total committed area, in words.</span>
<span class="new">+  size_t committed_words;</span>
 
<span class="removed">-  // Total used area, in words</span>
<span class="removed">-  size_t used() const { return _used; }</span>
<span class="new">+  // Total used area, in words.</span>
<span class="new">+  size_t used_words;</span>
 
<span class="removed">-  // Total free area (unused portions of current chunks), in words</span>
<span class="removed">-  size_t free() const { return _free; }</span>
<span class="new">+  // Total free committed area, in words.</span>
<span class="new">+  size_t free_words;</span>
 
<span class="removed">-  // Total waste area (unused portions of non-current chunks), in words</span>
<span class="removed">-  size_t waste() const { return _waste; }</span>
<span class="new">+  // Total waste committed area, in words.</span>
<span class="new">+  size_t waste_words;</span>
 
<span class="removed">-  // Total area spent in overhead (chunk headers), in words</span>
<span class="removed">-  size_t overhead() const { return _overhead; }</span>
<span class="new">+  in_use_chunk_stats_t()</span>
<span class="new">+    : num(0), word_size(0), committed_words(0),</span>
<span class="new">+      used_words(0), free_words(0), waste_words(0)</span>
<span class="new">+  {}</span>
 
<span class="removed">-  void add_num(uintx n) { _num += n; }</span>
<span class="removed">-  void add_cap(size_t s) { _cap += s; }</span>
<span class="removed">-  void add_used(size_t s) { _used += s; }</span>
<span class="removed">-  void add_free(size_t s) { _free += s; }</span>
<span class="removed">-  void add_waste(size_t s) { _waste += s; }</span>
<span class="removed">-  void add_overhead(size_t s) { _overhead += s; }</span>
<span class="new">+  void add(const in_use_chunk_stats_t&amp; other) {</span>
<span class="new">+    num += other.num;</span>
<span class="new">+    word_size += other.word_size;</span>
<span class="new">+    committed_words += other.committed_words;</span>
<span class="new">+    used_words += other.used_words;</span>
<span class="new">+    free_words += other.free_words;</span>
<span class="new">+    waste_words += other.waste_words;</span>
 
<span class="removed">-  void add(const UsedChunksStatistics&amp; other);</span>
<span class="new">+  }</span>
 
   void print_on(outputStream* st, size_t scale) const;
 
<span class="removed">-#ifdef ASSERT</span>
<span class="removed">-  void check_sanity() const;</span>
<span class="removed">-#endif</span>
<span class="new">+  DEBUG_ONLY(void verify() const;)</span>
 
<span class="removed">-}; // UsedChunksStatistics</span>
<span class="new">+};</span>
 
<span class="removed">-// Class containing statistics for one or more space managers.</span>
<span class="removed">-class SpaceManagerStatistics {</span>
<span class="new">+// Class containing statistics for one or more MetaspaceArena objects.</span>
<span class="new">+struct  arena_stats_t {</span>
 
<span class="removed">-  UsedChunksStatistics _chunk_stats[NumberOfInUseLists];</span>
<span class="removed">-  uintx _free_blocks_num;</span>
<span class="removed">-  size_t _free_blocks_cap_words;</span>
<span class="new">+  // chunk statistics by chunk level</span>
<span class="new">+  in_use_chunk_stats_t stats[chunklevel::NUM_CHUNK_LEVELS];</span>
<span class="new">+  uintx free_blocks_num;</span>
<span class="new">+  size_t free_blocks_word_size;</span>
 
<span class="removed">-public:</span>
<span class="new">+  arena_stats_t()</span>
<span class="new">+    : stats(),</span>
<span class="new">+      free_blocks_num(0),</span>
<span class="new">+      free_blocks_word_size(0)</span>
<span class="new">+  {}</span>
 
<span class="removed">-  SpaceManagerStatistics();</span>
<span class="new">+  void add(const arena_stats_t&amp; other);</span>
 
<span class="removed">-  // Chunk statistics by chunk index</span>
<span class="removed">-  const UsedChunksStatistics&amp; chunk_stats(ChunkIndex index) const   { return _chunk_stats[index]; }</span>
<span class="removed">-  UsedChunksStatistics&amp; chunk_stats(ChunkIndex index)               { return _chunk_stats[index]; }</span>
<span class="new">+  void print_on(outputStream* st, size_t scale = K,  bool detailed = true) const;</span>
 
<span class="removed">-  uintx free_blocks_num () const                                    { return _free_blocks_num; }</span>
<span class="removed">-  size_t free_blocks_cap_words () const                             { return _free_blocks_cap_words; }</span>
<span class="new">+  in_use_chunk_stats_t totals() const;</span>
 
<span class="removed">-  void reset();</span>
<span class="new">+  DEBUG_ONLY(void verify() const;)</span>
 
<span class="removed">-  void add_free_blocks_info(uintx num, size_t cap);</span>
<span class="new">+};</span>
 
<span class="removed">-  // Returns total chunk statistics over all chunk types.</span>
<span class="removed">-  UsedChunksStatistics totals() const;</span>
<span class="new">+// Statistics for one or multiple ClassLoaderMetaspace objects</span>
<span class="new">+struct clms_stats_t {</span>
 
<span class="removed">-  void add(const SpaceManagerStatistics&amp; other);</span>
<span class="removed">-</span>
<span class="removed">-  void print_on(outputStream* st, size_t scale,  bool detailed) const;</span>
<span class="new">+  arena_stats_t arena_stats_nonclass;</span>
<span class="new">+  arena_stats_t arena_stats_class;</span>
 
<span class="removed">-}; // SpaceManagerStatistics</span>
<span class="new">+  clms_stats_t() : arena_stats_nonclass(), arena_stats_class() {}</span>
 
<span class="removed">-class ClassLoaderMetaspaceStatistics {</span>
<span class="new">+  void add(const clms_stats_t&amp; other) {</span>
<span class="new">+    arena_stats_nonclass.add(other.arena_stats_nonclass);</span>
<span class="new">+    arena_stats_class.add(other.arena_stats_class);</span>
<span class="new">+  }</span>
 
<span class="removed">-  SpaceManagerStatistics _sm_stats[Metaspace::MetadataTypeCount];</span>
<span class="removed">-</span>
<span class="removed">-public:</span>
<span class="removed">-</span>
<span class="removed">-  ClassLoaderMetaspaceStatistics();</span>
<span class="removed">-</span>
<span class="removed">-  const SpaceManagerStatistics&amp; sm_stats(Metaspace::MetadataType mdType) const { return _sm_stats[mdType]; }</span>
<span class="removed">-  SpaceManagerStatistics&amp; sm_stats(Metaspace::MetadataType mdType)             { return _sm_stats[mdType]; }</span>
<span class="removed">-</span>
<span class="removed">-  const SpaceManagerStatistics&amp; nonclass_sm_stats() const { return sm_stats(Metaspace::NonClassType); }</span>
<span class="removed">-  SpaceManagerStatistics&amp; nonclass_sm_stats()             { return sm_stats(Metaspace::NonClassType); }</span>
<span class="removed">-  const SpaceManagerStatistics&amp; class_sm_stats() const    { return sm_stats(Metaspace::ClassType); }</span>
<span class="removed">-  SpaceManagerStatistics&amp; class_sm_stats()                { return sm_stats(Metaspace::ClassType); }</span>
<span class="removed">-</span>
<span class="removed">-  void reset();</span>
<span class="new">+  void print_on(outputStream* st, size_t scale, bool detailed) const;</span>
 
<span class="removed">-  void add(const ClassLoaderMetaspaceStatistics&amp; other);</span>
<span class="new">+  // Returns total statistics for both class and non-class metaspace</span>
<span class="new">+  arena_stats_t totals() const;</span>
 
<span class="removed">-  // Returns total space manager statistics for both class and non-class metaspace</span>
<span class="removed">-  SpaceManagerStatistics totals() const;</span>
 
<span class="removed">-  void print_on(outputStream* st, size_t scale, bool detailed) const;</span>
<span class="new">+  DEBUG_ONLY(void verify() const;)</span>
 
<span class="removed">-}; // ClassLoaderMetaspaceStatistics</span>
<span class="new">+};</span>
 
 } // namespace metaspace
 
 #endif // SHARE_MEMORY_METASPACE_METASPACESTATISTICS_HPP
<span class="new">+</span>
</pre>
<center><a href='../../../../../src/hotspot/share/memory/metaspace/metaspaceStatistics.cpp.udiff.html' target='_top'>&lt prev</a> <a href='../../../../../index.html' target='_top'>index</a> <a href='../../../../../src/hotspot/share/memory/metaspace/virtualSpaceList.cpp.udiff.html' target='_top'>next &gt</a></center>
</body></html>

